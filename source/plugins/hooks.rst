プラグインのフック
============

新しいAPIのメソッドを追加する
-------------------

Kanboard は API 呼び出しのハンドルに `JSON-RPC <https://github.com/fguillot/JsonRPC>`__ ライブラリを使用しています。

以下の要領で、あなたのプラグインから新しいメソッドを追加できます。

.. code:: php

    $this->api->getProcedureHandler()->withCallback('my_method', function() {
        return 'foobar';
    });

``$this->container['api']`` か、 ``$this->api`` がインスタンスのオブジェクト ``JsonRPC\Server`` を示します。

さらなる情報はライブラリの文書を参照願います。

新しいコンソールのコマンドを追加
------------------------

Kanboard は `Symfony
Console <http://symfony.com/doc/current/components/console/introduction.html>`__
ライブラリをローカルのコマンドラインのハンドルに使用しています。

 ``$this->cli`` 経由で インスタンスのオブジェクト ``Symfony\Component\Console\Application``  が Kanboard に示されます。プラグインから新しいコマンドを追加することができます::

.. code:: php

    $this->cli->add(new MyCommand());

さらなる情報はライブラリの文書を参照願います。

新しいタスクのフィルターを追加する
--------------------

タスクの字句解析器が新しいインスタンスを都度返すので、  ``extend()`` メソッドか、pimpleによって ``taskLexer`` コンテナを拡張しなければなりません。

ここに例を示します:

.. code:: php

    public function initialize()
    {
        $this->container->extend('taskLexer', function($taskLexer, $c) {
            $taskLexer->withFilter(TaskBoardDateFilter::getInstance($c)->setDateParser($c['dateParser']));
            return $taskLexer;
        });
    }

いくつかのフィルタークラスの実装の例は、 ``Kanboard\Filter`` 名前空間の下のソースコードにあります。

アプリケーションのフック
-----------------

フックは拡張、置き換えが可能で、デフォルトでの動作はデータのフィルタリングや変更です。
各々のフックは、例えば ``controller:calendar:user:events`` のように、ユニークな名前で識別されます。

イベントのフックのリッスン
~~~~~~~~~~~~~~~~~~~~~

``initialize()`` メソッド内で、``Kanboard\Core\Plugin\Hook`` クラス内の ``on()`` メソッドを呼ぶ必要があります:

.. code:: php

    $this->hook->on('hook_name', $callable);

最初の引数はフックの名前で、2つめはPHPのcallableです。

フックを一度だけ実行する
~~~~~~~~~~~~~~~~~~~~~~~~

いくつかのフックは一つだけのリスナーを持つことができます: ``model:subtask-time-tracking:calculate:time-spent``

-  サブタスクのタイマーが止まった時、消費時間の計算をオーバーライドする
-  引数:

   -  ``$user_id`` (integer)
   -  ``$start`` (DateTime)
   -  ``$end`` (DateTime)

フックのマージ
-----------

“フックのマージ” の挙動は ``array_merge`` 関数と同様です。フックのコールバックは配列を返す必要があります。この配列は最初の配列にマージされます。

ユーザーのカレンダーにイベントを追加する例:

.. code:: php

    class Plugin extends Base
    {
        public function initialize()
        {
            $container = $this->container;

            $this->hook->on('controller:calendar:user:events', function($user_id, $start, $end) use ($container) {
                $model = new SubtaskForecast($container);
                return $model->getCalendarEvents($user_id, $end); // Return new events
            });
        }
    }

タスクのフォームのデフォルト値をオーバーライドする例:

.. code:: php

    class Plugin extends Base
    {
        public function initialize()
        {
            $this->hook->on('controller:task:form:default', function (array $default_values) {
                return empty($default_values['score']) ?array('score' => 4) : array();
            });
        }
    }

マージしたフックのリスト:

``controller:task:form:default``

タスクのフォームのデフォルト値をオーバーライド
-  引数:

   -  ``$default_values``: 実際のデフォルト値 (array)

``controller:calendar:project:events``

-  プロジェクトのカレンダーにイベントを追加する
-  引数:

   -  ``$project_id`` (integer)
   -  ``$start`` カレンダーの開始日 (string, ISO-8601 書式)
   -  ``$end`` カレンダーの終了日 (string, ISO-8601 書式)

``controller:calendar:user:events``

- ユーザーのカレンダーに更にイベントを追加する場合
-  引数:

   -  ``$user_id`` (integer)
   -  ``$start`` カレンダーの開始日 (string, ISO-8601 書式)
   -  ``$end`` カレンダーの終了日 (string, ISO-8601 書式)

アセットのフック
-----------

アセットのフックは簡単に新しいスタイルシートを追加したり、レイアウトに新しくJavaScriptファイルを追加するのに利用されます。この特徴を利用すると、新しいテーマを作成して Kanboard のデフォルトのスタイルをオーバーライドすることができます。

新しいスタイルシートを追加する例:

.. code:: php

    <?php

    namespace Kanboard\Plugin\Css;

    use Kanboard\Core\Plugin\Base;

    class Plugin extends Base
    {
        public function initialize()
        {
            $this->hook->on('template:layout:css', array('template' => 'plugins/Css/skin.css'));
        }
    }

アセットのフックのリスト:

-  ``template:layout:css``
-  ``template:layout:js``

フックの参照
---------------

フックの参照は、変数の参照はパスされます。

例:

.. code:: php

    $this->hook->on('formatter:board:query', function (\PicoDb\Table &query) {
        $query->eq(TaskModel::TABLE.'color_id', 'red');
    });

上述のコードはボード上のタスクを赤のみで表示します。

フックのリストの参照:

+----------------------------------------+---------------------------------------------------------------+
| フック                                 | 概要                                                   |
+========================================+===============================================================+
| ``formatter:board:query``              | ボードのレンダリング前にデータベースのクエリを変更する                   |
+----------------------------------------+---------------------------------------------------------------+
| ``pagination:dashboard:project:query`` | ダッシュボード上のプロジェクトの順序変更のためにデータベースのクエリを変更する |
+----------------------------------------+---------------------------------------------------------------+
| ``pagination:dashboard:task:query``    | ダッシュボード上のタスクの順序変更のためにデータベースのクエリを変更する    |
+----------------------------------------+---------------------------------------------------------------+
| ``pagination:dashboard:subtask:query`` | ダッシュボード上のサブタスクの順序変更のためにデータベースのクエリを変更する |
+----------------------------------------+---------------------------------------------------------------+
| ``model:task:creation:prepare``        | 値を保存する前にデータベースのクエリを変更する                      |
+----------------------------------------+---------------------------------------------------------------+
| ``model:task:creation:aftersave``      | タスクを作成した後に、タスクIDを取得する                        |
+----------------------------------------+---------------------------------------------------------------+
| ``model:task:modification:prepare``    | タスクを変更する前にフォームの値を変更する                       |
+----------------------------------------+---------------------------------------------------------------+
| ``model:task:duplication:aftersave``   | 後でタスクを複製する                                       |
+----------------------------------------+---------------------------------------------------------------+
| ``model:color:get-list``               | デフォルト色の値を変更する                                   |
+----------------------------------------+---------------------------------------------------------------+
| ``model:subtask:modification:prepare`` | サブタスクを変更する前にフォームの値を変更する                   |
+----------------------------------------+---------------------------------------------------------------+
| ``model:subtask:creation:prepare``     | サブタスクを作成する前にフォームの値を変更する                    |
+----------------------------------------+---------------------------------------------------------------+
| ``model:subtask:count:query``          | サブタスクをカウントする                        |
+----------------------------------------+---------------------------------------------------------------+

フックのテンプレート
--------------

フックのテンプレートは既存のテンプレートに内容を追加することができます。

ダッシュボードのサイドバーに新しい内容を追加する例:

.. code:: php

    $this->template->hook->attach('template:dashboard:sidebar', 'myplugin:dashboard/sidebar');

テンプレートにローカル変数を付ける例:

.. code:: php

    $this->template->hook->attach('template:dashboard:sidebar', 'myplugin:dashboard/sidebar', [
        'variable' => 'foobar',
    ]);

テンプレートにcallableを付ける例:

.. code:: php

    $this->template->hook->attachCallable('template:dashboard:sidebar', 'myplugin:dashboard/sidebar', function($hook_param1, $hook_param2) {
        return ['new_template_variable' => 'foobar']; // Inject a new variable into the plugin template
    });

この呼び出しは ``initialize()``メソッド内の定義に使われます。最初の引数はフックの名前で、2つ目の引数はテンプレート名です。

テンプレート名はプラグイン名の接頭辞で、コロン(:)でテンプレートの場所を示します。

``myplugin:dashboard/sidebar`` を例にとります:

-  ``myplugin`` はあなたのプラグイン名 (小文字)
-  ``dashboard/sidebar`` はテンプレート名です
-  ファイルシステム上では、プラグインは以下にあります:
   ``plugins\Myplugin\Template\dashboard\sidebar.php``
-  テンプレートは純粋なPHPで書かれています (エスケープのデータを忘れないでください)

テンプレート名はコアとなるテンプレートの接頭辞はありません.

フックのテンプレートのリスト:

+-----------------------------------------------------------+--------------------------------+
| フック                                                      | 概要                    |
+===========================================================+================================+
| ``template:analytic:sidebar``                             | 統計ページのサイドバー      |
+-----------------------------------------------------------+--------------------------------+
| ``template:app:filters-helper:before``                    | フィルターのヘルパーのドロップダウン (上部)   |
+-----------------------------------------------------------+--------------------------------+
| ``template:app:filters-helper:after``                     | フィルターのヘルパーのドロップダウン (下部)|
+-----------------------------------------------------------+--------------------------------+
| ``template:auth:login-form:before``                       | ログインページ (上部)                |
+-----------------------------------------------------------+--------------------------------+
| ``template:auth:login-form:after``                        | ログインページ (下部)            |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:private:task:before-title``              | 個人ボード内のタスク: タイトルの前  |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:private:task:after-title``               | 個人ボード内のタスク: タイトルの後   |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:public:task:before-title``               | 公開ボード内のタスク: タイトルの前    |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:public:task:after-title``                | 公開ボード内のタスク: タイトルの後    |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:task:footer``                            | ボード内タスク: フッター          |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:task:icons``                             | ボード内タスク:  ツールチップのアイコン    |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:table:column:before-header-row``         | ボードのヘッダー列より上の行 |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:table:column:after-header-row``          | ボードのヘッダー列以降の行  |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:column:dropdown``                        | ボードのカラム内のドロップダウンメニュー |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:column:header``                          | ボードのカラムのヘッダー            |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:tooltip:subtasks:header:before-assignee``| サブタスクの表のヘッダー上で、未割当サブタスクのツールチップ        |
+-----------------------------------------------------------+--------------------------------+
| ``template:board:tooltip:subtasks:rows``                  |  Column on row of Subtask table on tooltip                     |
+-----------------------------------------------------------+--------------------------------+
| ``template:config:sidebar``                               | 設定ページ上のサイドバー       |
+-----------------------------------------------------------+--------------------------------+
| ``template:config:application``                           | アプリケーションの設定フォーム      |
+-----------------------------------------------------------+--------------------------------+
| ``template:config:board``                                 | ボードの設定フォーム            |
+-----------------------------------------------------------+--------------------------------+
| ``template:config:email``                                 | Email の設定ページ            |
+-----------------------------------------------------------+--------------------------------+
| ``template:config:integrations``                          | グローバル設定内の連携のページ                       |
+-----------------------------------------------------------+--------------------------------+
| ``template:dashboard:show``                               | ダッシュボードのメインページ     |
+-----------------------------------------------------------+--------------------------------+
| ``template:dashboard:page-header:menu``                   | ダッシュボードのサブメニュー             |
+-----------------------------------------------------------+--------------------------------+
| ``template:dashboard:task:footer``                        | ダッシュボード内のタスク: フッター      |
+-----------------------------------------------------------+--------------------------------+
| ``template:header:dropdown``                              | ドロップダウンメニューのページのヘッダー      |
|                                                           | (ユーザーアバターのアイコン)             |
+-----------------------------------------------------------+--------------------------------+
| ``template:header:creation-dropdown``                     | ドロップダウンメニューのページのヘッダー     |
|                                                           | (＋ アイコン)                    |
+-----------------------------------------------------------+--------------------------------+
| ``template:layout:head``                                  |  ``<head/>``タグでのページレイアウト    |
+-----------------------------------------------------------+--------------------------------+
| ``template:layout:top``                                   | ヘッダーのページレイアウト         |
+-----------------------------------------------------------+--------------------------------+
| ``template:layout:bottom``                                | フッターのページレイアウト             |
+-----------------------------------------------------------+--------------------------------+
| ``template:project:dropdown``                             | “Actions” menu on left in      |
|                                                           | different project views        |
+-----------------------------------------------------------+--------------------------------+
| ``template:project:header:before``                        | プロジェクトフィルター (前)       |
+-----------------------------------------------------------+--------------------------------+
| ``template:project:header:after``                         | プロジェクトフィルター (後)        |
+-----------------------------------------------------------+--------------------------------+
| ``template:project:integrations``                         | プロジェクト設定内の連携のページ                       |
+-----------------------------------------------------------+--------------------------------+
| ``template:project:sidebar``                              | プロジェクト設定内のサイドバー    |
+-----------------------------------------------------------+--------------------------------+
| ``template:project-user:sidebar``                         | プロジェクトのユーザー概要ページのサイドバー     |
+-----------------------------------------------------------+--------------------------------+
| ``template:project-list:menu:before``                     | プロジェクトのリスト: メニューエントリーの前      |
+-----------------------------------------------------------+--------------------------------+
| ``template:project-list:menu:after``                      | プロジェクトのリスト: メニューエントリーの後      |
+-----------------------------------------------------------+--------------------------------+
| ``template:project-overview:before-description``          | プロジェクト概要: プロジェクトの説明の前       |
+-----------------------------------------------------------+--------------------------------+
| ``template:project-header:view-switcher``                 | プロジェクトビュー切り替え          |
+-----------------------------------------------------------+--------------------------------+
| ``template:search:task:footer``                           | Task in results: footer        |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:layout:top``                              | タスクのレイアウトのトップ (ページのヘッダーの後)    |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:top``                             | タスク概要トップ               |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:bottom``                          | タスク概要の下            |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:first-column``                    | タスク概要の1番目のカラム     |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:second-column``                   | タスク概要の2番目のカラム     |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:third-column``                    | タスク概要の3番目のカラム      |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:details:fourth-column``                   | タスク概要の4番目のカラム     |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:dropdown:before-actions``                         | タスクのドロップダウン: メニューのトップ            |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:dropdown:after-basic-actions``                    | タスクのドロップダウン:  "サブタスクを追加" の後    |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:dropdown:after-add-links``                        | タスクのドロップダウン:  "外部リンクを追加" の後  |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:dropdown:after-add-comment``                      | タスクのドロップダウン:  "コメントを追加" の後   |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:dropdown:after-add-attachments``                  | タスクのドロップダウン:  "スクリーンショットを追加" の後 |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:dropdown:after-duplicate-task``                   | タスクのドロップダウン:  "...に複製 " の後 |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:dropdown:after-send-mail``                        | タスクのドロップダウン:  "メールで送信" の後 |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:dropdown``                                        | タスクのドロップダウン:  メニューの最下段         |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:information``                             | タスクのサイドバー: [section] 情報   |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:before-actions``                          | Task sidebar: [section] actions: top  |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-basic-actions``                     | ... 上に同じ: "サブタスクを追加" の後   |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-add-links``                         | ... 上に同じ: "外部リンクを追加" の後  |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-add-comment``                       | ... 上に同じ: "コメントを追加" の後      |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-add-attachments``                   | ... 上に同じ: "スクリーンショットを追加" の後 |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-duplicate-task``                    | ... 上に同じ: "...に複製 " の後 |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:after-send-mail``                         | ... 上に同じ: "メールで送信" の後"    |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task:sidebar:actions``                                 | ... 上に同じ: 最下段                  |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task-file:images:dropdown``                            | Task image attachment dropdown        |
+-------------------------------------------------------------------+---------------------------------------+
| ``template:task-file:images:before-thumbnail-description``        | Task image attachment desciption      |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:form:first-column``                       | タスクのフォームの1番目のカラム       |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:form:second-column``                      | タスクのフォームの2番目のカラム        |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:form:third-column``                       | タスクのフォームの3番目のカラム        |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:top``                                | タスクのページを表示: 先頭            |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:bottom``                             | タスクのページを表示: 末尾         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-description``                 | タスクのページを表示: 概要の前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-tasklinks``                   | タスクのページを表示: タスクリンクの前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-subtasks``                    | タスクのページを表示: サブタスクの前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-timetracking``                | タスクのページを表示: 時間追跡の前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-attachments``                 | タスクのページを表示: 添付の前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:task:show:before-comments``                    | タスクのページを表示: コメントの前         |
+-----------------------------------------------------------+--------------------------------+
| ``template:subtask:form:create``                          | サブタスク作成フォーム            |
+-----------------------------------------------------------+--------------------------------+
| ``template:subtask:form:edit``                            | サブタスク編集フォーム              |
+-----------------------------------------------------------+--------------------------------+
| ``template:subtask:table:header:before-timetracking``     | 時間追跡の前のサブタスクの表のヘッダー    |
+-----------------------------------------------------------+--------------------------------+
| ``template:subtask:table:rows``                           | Column on row of subtasks      |
|                                                           | table                          |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:authentication:form``                     | ユーザー設定内の “'認証の編集” フォーム  |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:create-remote:form``                      | “リモートユーザーを作成" フォーム      |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:external``                                | ユーザー設定内の “外部認証を設定” ページ |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:integrations``                            | ユーザー設定内の "連携" ページ     |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:sidebar:actions``                         | ユーザー設定内のサイドバー (section actions)              |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:sidebar:information``                     | ユーザー設定内のサイドバー (section information)          |
+-----------------------------------------------------------+--------------------------------+
| ``template:user:show:profile:info``                       | ユーザー設定情報       |
+-----------------------------------------------------------+--------------------------------+
